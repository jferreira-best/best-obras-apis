# Azure Function + Semantic Kernel ‚Äî README

## üìò Vis√£o Geral

Este projeto implementa uma **Azure Function (Python)** integrada ao **Semantic Kernel (SK)**, atuando como um **Agente Orquestrador** para unificar e automatizar fluxos entre as APIs educacionais (SED, CESU, ENEM, ENCCEJA, Plataformas de Aprendizagem, Gov.br, etc.).
O objetivo √© criar **resili√™ncia, recupera√ß√£o autom√°tica e orquestra√ß√£o inteligente** de processos pedag√≥gicos e administrativos.

A arquitetura combina **Azure Functions**, **Semantic Kernel**, **API Management (APIM)** e **Application Insights**, garantindo seguran√ßa, rastreabilidade e automa√ß√£o em larga escala.

---

## üß© Principais Componentes

| Componente               | Fun√ß√£o                                                                                       |
| ------------------------ | -------------------------------------------------------------------------------------------- |
| **Function App**         | Endpoint central (HTTP Trigger) para receber inten√ß√µes e executar planos via Semantic Kernel |
| **Semantic Kernel**      | Motor de orquestra√ß√£o (Planner + Plugins) que traduz inten√ß√µes em a√ß√µes concretas nas APIs   |
| **Plugins (Skills)**     | Implementam integra√ß√£o com cada dom√≠nio de API (SED, Gov.br, Certificados, etc.)             |
| **Azure Storage**        | Persist√™ncia de autosave e logs t√©cnicos                                                     |
| **Redis Cache**          | Armazena tokens e dados tempor√°rios para performance                                         |
| **Key Vault**            | Armazena segredos e chaves com Managed Identity                                              |
| **Application Insights** | Telemetria e rastreamento de falhas                                                          |

---

## üèóÔ∏è Estrutura de Pastas

```
azfunc-sk-orchestrator/
‚îú‚îÄ host.json
‚îú‚îÄ requirements.txt
‚îú‚îÄ local.settings.json
‚îú‚îÄ shared/               # Configura√ß√µes, auth, HTTP utils, storage e telemetry
‚îú‚îÄ sk/                   # Semantic Kernel, planners e plugins
‚îú‚îÄ orchestrate/          # Function principal (HTTP Trigger / API Gateway)
‚îú‚îÄ webhooks/             # Entrada de eventos (travamento, alerta)
‚îî‚îÄ activities/           # Fun√ß√µes longas ou ass√≠ncronas (auditoria, sync)
```

---

## ‚öôÔ∏è Instala√ß√£o Local

### 1Ô∏è‚É£ Preparar ambiente virtual

```bash
python -m venv .venv
source .venv/bin/activate   # Windows: .venv\\Scripts\\activate
```

### 2Ô∏è‚É£ Instalar depend√™ncias

```bash
pip install -r requirements.txt
```

### 3Ô∏è‚É£ Configurar vari√°veis locais

Copie o exemplo:

```bash
cp local.settings.example.json local.settings.json
```

Edite o arquivo e preencha:

```json
{
  "Values": {
    "OPENAI_API_BASE": "https://<seu-aoai>.openai.azure.com/",
    "OPENAI_API_KEY": "<chave_dev>",
    "OPENAI_DEPLOYMENT": "gpt-4o-mini",
    "APIM_BASE": "https://api.sua-org.com"
  }
}
```

### 4Ô∏è‚É£ Executar localmente

```bash
func start
```

Acesse via:

```
http://localhost:7071/api/orchestrate
```

---

## üöÄ Exemplo de Requisi√ß√£o

### Verificar Certificado ENEM/ENCCEJA

```bash
curl -X POST http://localhost:7071/api/orchestrate \
  -H "Content-Type: application/json" \
  -d '{"intent":"verificar_certificado", "inputs": {"cpf": "12345678901"}}'
```

### Diagn√≥stico SED

```bash
curl -X POST http://localhost:7071/api/orchestrate \
  -H "Content-Type: application/json" \
  -d '{"intent":"diagnosticar_sed", "inputs": {"cpf": "12345678901"}}'
```

---

## üß† Integra√ß√£o Semantic Kernel

Cada m√≥dulo em `sk/plugins` representa uma **Skill**. Exemplo:

* `GovBrSkill` ‚Üí `/api/govbr/status/{cpf}`
* `CertificadosSkill` ‚Üí `/api/certificados/{cpf}`
* `SEDLogsSkill` ‚Üí `/api/sed/logs?cpf={cpf}`
* `FallbackAutosaveSkill` ‚Üí autosave local e reenvio em falhas

### Planner

O arquivo `sk/planners/basic.py` cont√©m o **prompt do orquestrador**, que instrui o modelo a:

1. Validar sess√£o Gov.br.
2. Consultar logs SED.
3. Verificar status de sincroniza√ß√£o.
4. Garantir autosave e reenvio autom√°tico.
5. Emitir alertas preventivos (webhook).

---

## üîê Seguran√ßa

* **Managed Identity** habilitado no Function App.
* Segredos armazenados no **Key Vault**.
* Autentica√ß√£o nas APIs via **APIM** com JWT ou OAuth.
* **PII Masking** para dados sens√≠veis (CPF, RA).

---

## üìä Telemetria e Logs

Integrado com **Application Insights**:

* Eventos (`log_event`) para cada requisi√ß√£o.
* Lat√™ncia e falhas agrupadas por Skill.
* M√©tricas autom√°ticas via OpenTelemetry.

---

## üõ°Ô∏è Fluxos Suportados

| Inten√ß√£o                | A√ß√£o Executada                                                       |
| ----------------------- | -------------------------------------------------------------------- |
| `verificar_certificado` | Consulta `/api/certificados/status/{cpf}`                            |
| `diagnosticar_sed`      | Consulta `/api/sed/logs?cpf={cpf}`                                   |
| `reenviar_autosave`     | Reenvia dados do cache local via `/api/salafuturo/registro/reenviar` |
| `status_sincronizacao`  | Verifica `/api/aprendizagem/sincronizacao?ra={ra}`                   |
| `ping`                  | Teste de conectividade                                               |

---

## ‚òÅÔ∏è Deploy no Azure

### 1Ô∏è‚É£ Login e cria√ß√£o do Function App

```bash
az login
az functionapp create --resource-group rg-edu --consumption-plan-location brazilsouth \
  --runtime python --runtime-version 3.11 --functions-version 4 --name func-sk-orq --storage-account <storage>
```

### 2Ô∏è‚É£ Publicar c√≥digo

```bash
func azure functionapp publish func-sk-orq
```

### 3Ô∏è‚É£ Configurar vari√°veis de ambiente

```bash
az functionapp config appsettings set -g rg-edu -n func-sk-orq \
  --settings OPENAI_API_BASE=https://<aoai>.openai.azure.com/ \
             OPENAI_DEPLOYMENT=gpt-4o-mini \
             APIM_BASE=https://api.sua-org.com
```

---

## üîÅ Pr√≥ximos Passos

* [ ] Criar Skill de **Ouvidoria** (`/api/chamados/ouvidoria`)
* [ ] Adicionar **Durable Functions** para sincroniza√ß√µes longas
* [ ] Integrar **Service Bus** para tickets autom√°ticos
* [ ] Criar **Dashboard Power BI** via Application Insights API

---

## üë®‚Äçüíª Autor

**Jos√© Marcos Ferreira**
AI Engineer / Data Solutions Architect
Projeto: *Agente Orquestrador Educacional ‚Äî Secretaria de Educa√ß√£o SP*
